#!/usr/bin/env python3
"""
oil_price_forecast.py
Calm, robust, professional oil forecast (WTI + Brent)
Yahoo Finance only
"""

import json
import numpy as np
import pandas as pd
from datetime import datetime
import yfinance as yf
from sklearn.ensemble import RandomForestClassifier

# =========================
# CONFIG
# =========================
START_DATE = "2012-01-01"

SYMBOL_WTI = "CL=F"
SYMBOL_BRENT = "BZ=F"

PROB_THRESHOLD = 0.57
OUTPUT_TXT = "oil_forecast.txt"

# =========================
# HELPERS
# =========================
def fetch_price(symbol):
    df = yf.download(symbol, start=START_DATE, progress=False)
    df = df[["Close"]].rename(columns={"Close": symbol})
    return df.dropna()

def build_features(df):
    df = df.copy()

    df["Return"] = df.iloc[:, 0].pct_change()
    df["Momentum_5"] = df.iloc[:, 0].pct_change(5)
    df["Momentum_10"] = df.iloc[:, 0].pct_change(10)
    df["Volatility_5"] = df["Return"].rolling(5).std()
    df["SMA_50"] = df.iloc[:, 0].rolling(50).mean()

    df["Target"] = (df["Return"].shift(-1) > 0).astype(int)

    df = df.dropna()
    return df

def train_model(df):
    features = ["Return", "Momentum_5", "Momentum_10", "Volatility_5"]
    X = df[features]
    y = df["Target"]

    model = RandomForestClassifier(
        n_estimators=300,
        max_depth=6,
        min_samples_leaf=10,
        random_state=42
    )
    model.fit(X, y)
    return model, features

# =========================
# MAIN
# =========================
def run_forecast(symbol, name):
    df_raw = fetch_price(symbol)
    df = build_features(df_raw)

    model, features = train_model(df)

    last = df.iloc[-1:]
    prob_up = model.predict_proba(last[features])[0][1]

    price = float(df_raw.iloc[-1, 0])
    sma50 = float(df["SMA_50"].iloc[-1])

    trend_ok = price > sma50
    signal = "NO_TRADE"

    if prob_up >= PROB_THRESHOLD and trend_ok:
        signal = "LONG"

    return {
        "instrument": name,
        "price": round(price, 2),
        "prob_up": round(prob_up * 100, 2),
        "trend": "UP" if trend_ok else "DOWN",
        "signal": signal
    }

def main():
    now = datetime.utcnow().strftime("%Y-%m-%d %H:%M:%S UTC")

    wti = run_forecast(SYMBOL_WTI, "WTI")
    brent = run_forecast(SYMBOL_BRENT, "BRENT")

    lines = []
    lines.append("===================================")
    lines.append("        OIL PRICE FORECAST")
    lines.append("===================================")
    lines.append(f"Run time (UTC): {now}")
    lines.append("")

    for r in (wti, brent):
        lines.append(f"{r['instrument']}")
        lines.append(f"Price        : {r['price']}")
        lines.append(f"Prob UP      : {r['prob_up']}%")
        lines.append(f"Trend        : {r['trend']}")
        lines.append(f"Signal       : {r['signal']}")
        lines.append("-----------------------------------")

    with open(OUTPUT_TXT, "w", encoding="utf-8") as f:
        f.write("\n".join(lines))

    print("[OK] Forecast written to", OUTPUT_TXT)

if __name__ == "__main__":
    main()
